(function(window,document){'use strict';class AjaxManager{constructor(core){this.core=core;this.requestQueue=[];this.activeRequests=new Map();this.requestHistory=[];this.maxRetries=3;this.baseDelay=1000;this.timeout=30000;this.maxConcurrentRequests=5;this.metrics={totalRequests: 0,successfulRequests: 0,failedRequests: 0,retriedRequests: 0,averageResponseTime: 0,totalResponseTime: 0};this.notificationCallbacks=new Set();this.init();}init(){this.setupRequestInterceptors();this.startQueueProcessor();this.setupPerformanceMonitoring();this.core.log('AjaxManager initialized',{maxRetries: this.maxRetries,timeout: this.timeout,maxConcurrentRequests: this.maxConcurrentRequests});}setupRequestInterceptors(){if(window.fetch){const originalFetch=window.fetch;window.fetch=(...args)=>{return originalFetch.apply(this,args).catch(error=>{this.handleGlobalError('fetch',error);throw error;});};}}startQueueProcessor(){setInterval(()=>{this.processQueue();},100);}setupPerformanceMonitoring(){setInterval(()=>{this.reportMetrics();},30000);}async request(action,data={},options={}){const requestId=this.generateRequestId();const requestConfig={id: requestId,action,data,options:{method: 'POST',timeout: this.timeout,retries: this.maxRetries,priority: 'normal',...options},attempt: 0,startTime: Date.now()};try{this.core.log(`AJAX request initiated: ${action}`,{requestId,data});if(this.activeRequests.size >=this.maxConcurrentRequests){return this.queueRequest(requestConfig);}else{return this.executeRequest(requestConfig);}}catch(error){this.core.handleError(`AJAX request failed: ${action}`,error);throw error;}}queueRequest(requestConfig){return new Promise((resolve,reject)=>{requestConfig.resolve=resolve;requestConfig.reject=reject;const priority=requestConfig.options.priority;const insertIndex=this.findInsertIndex(priority);this.requestQueue.splice(insertIndex,0,requestConfig);this.core.log(`Request queued: ${requestConfig.action}`,{queueLength: this.requestQueue.length,priority});});}findInsertIndex(priority){const priorities={high: 0,normal: 1,low: 2};const requestPriority=priorities[priority] || 1;for(let i=0;i < this.requestQueue.length;i++){const queuedPriority=priorities[this.requestQueue[i].options.priority] || 1;if(requestPriority < queuedPriority){return i;}}return this.requestQueue.length;}processQueue(){while(this.requestQueue.length > 0 && this.activeRequests.size < this.maxConcurrentRequests){const requestConfig=this.requestQueue.shift();this.executeRequest(requestConfig).then(requestConfig.resolve).catch(requestConfig.reject);}}async executeRequest(requestConfig){const{id,action,data,options}=requestConfig;this.activeRequests.set(id,requestConfig);this.metrics.totalRequests++;try{const response=await this.performRequest(requestConfig);this.activeRequests.delete(id);this.metrics.successfulRequests++;this.updateResponseTime(requestConfig);this.addToHistory(requestConfig,response,'success');this.core.emit('ajax:success',{action,response,requestId: id});return response;}catch(error){if(requestConfig.attempt < options.retries && this.shouldRetry(error)){return this.retryRequest(requestConfig,error);}else{this.activeRequests.delete(id);this.metrics.failedRequests++;this.addToHistory(requestConfig,error,'failed');this.core.emit('ajax:error',{action,error,requestId: id});this.showUserNotification('error',`Request failed: ${action}`);throw error;}}}async performRequest(requestConfig){const{action,data,options}=requestConfig;const requestData=this.prepareRequestData(action,data);const controller=new AbortController();const timeoutId=setTimeout(()=> controller.abort(),options.timeout);try{let response;if(window.fetch && options.useFetch !==false){response=await this.fetchRequest(requestData,controller.signal);}else{response=await this.xhrRequest(requestData,controller.signal);}clearTimeout(timeoutId);return this.processResponse(response,requestConfig);}catch(error){clearTimeout(timeoutId);if(error.name==='AbortError'){throw new Error(`Request timeout: ${action}`);}throw error;}}prepareRequestData(action,data){const requestData={action: `las_${action}`,nonce: this.getNonce(),...data};if(!requestData.nonce){throw new Error('CSRF token(nonce)is missing');}return requestData;}getNonce(){return this.core.config.nonce || window.lasAjax?.nonce || document.querySelector('#las-nonce')?.value || document.querySelector('meta[name="las-nonce"]')?.content;}async fetchRequest(data,signal){const formData=new FormData();Object.entries(data).forEach(([key,value])=>{if(value !==null && value !==undefined){formData.append(key,typeof value==='object' ? JSON.stringify(value): value);}});const response=await fetch(this.getAjaxUrl(),{method: 'POST',body: formData,credentials: 'same-origin',signal});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}return response;}xhrRequest(data,signal){return new Promise((resolve,reject)=>{const xhr=new XMLHttpRequest();if(signal){signal.addEventListener('abort',()=>{xhr.abort();reject(new Error('Request aborted'));});}xhr.open('POST',this.getAjaxUrl(),true);xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');xhr.onload=()=>{if(xhr.status >=200 && xhr.status < 300){resolve({ok: true,status: xhr.status,statusText: xhr.statusText,text:()=> Promise.resolve(xhr.responseText),json:()=> Promise.resolve(JSON.parse(xhr.responseText))});}else{reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));}};xhr.onerror=()=> reject(new Error('Network error'));xhr.ontimeout=()=> reject(new Error('Request timeout'));const formData=new FormData();Object.entries(data).forEach(([key,value])=>{if(value !==null && value !==undefined){formData.append(key,typeof value==='object' ? JSON.stringify(value): value);}});xhr.send(formData);});}async processResponse(response,requestConfig){let responseData;try{const text=await response.text();try{responseData=JSON.parse(text);}catch(parseError){responseData={data: text,success: true};}if(responseData.success===false){throw new Error(responseData.data?.message || 'Request failed');}return responseData.data || responseData;}catch(error){this.core.handleError('Failed to process response',error,{action: requestConfig.action,status: response.status});throw error;}}async retryRequest(requestConfig,error){requestConfig.attempt++;this.metrics.retriedRequests++;const delay=this.calculateBackoffDelay(requestConfig.attempt);this.core.log(`Retrying request: ${requestConfig.action}`,{attempt: requestConfig.attempt,delay,error: error.message});this.showUserNotification('warning',`Retrying request...(${requestConfig.attempt}/${requestConfig.options.retries})`);await this.delay(delay);return this.executeRequest(requestConfig);}calculateBackoffDelay(attempt){const jitter=Math.random()*0.1;return Math.min(this.baseDelay*Math.pow(2,attempt-1)*(1+jitter),30000);}shouldRetry(error){if(error.message.includes('HTTP 4')){const retryable4xx=['408','429'];return retryable4xx.some(code=> error.message.includes(code));}if(error.message.includes('HTTP 5')|| error.message.includes('Network error')|| error.message.includes('timeout')){return true;}if(error.message.includes('nonce')|| error.message.includes('CSRF')){return false;}return true;}getAjaxUrl(){return this.core.config.ajaxUrl || window.ajaxurl || '/wp-admin/admin-ajax.php';}generateRequestId(){return 'req-'+Date.now()+'-'+Math.random().toString(36).substr(2,9);}addToHistory(requestConfig,result,status){const historyEntry={id: requestConfig.id,action: requestConfig.action,status,duration: Date.now()-requestConfig.startTime,attempts: requestConfig.attempt+1,timestamp: new Date().toISOString(),result: status==='success' ? 'Success' : result.message};this.requestHistory.unshift(historyEntry);if(this.requestHistory.length > 100){this.requestHistory=this.requestHistory.slice(0,100);}}updateResponseTime(requestConfig){const responseTime=Date.now()-requestConfig.startTime;this.metrics.totalResponseTime+=responseTime;this.metrics.averageResponseTime=this.metrics.totalResponseTime/this.metrics.successfulRequests;}showUserNotification(type,message){const notification={type,message,timestamp: Date.now()};this.core.emit('ajax:notification',notification);this.notificationCallbacks.forEach(callback=>{try{callback(notification);}catch(error){this.core.handleError('Notification callback error',error);}});}onNotification(callback){this.notificationCallbacks.add(callback);}offNotification(callback){this.notificationCallbacks.delete(callback);}handleGlobalError(source,error){this.core.handleError(`Global ${source}error`,error);this.showUserNotification('error','A network error occurred. Please try again.');}delay(ms){return new Promise(resolve=> setTimeout(resolve,ms));}reportMetrics(){const metrics=this.getMetrics();this.core.emit('ajax:metrics',metrics);if(this.core.config.debug){this.core.log('AJAX performance metrics',metrics);}}getMetrics(){return{...this.metrics,activeRequests: this.activeRequests.size,queuedRequests: this.requestQueue.length,successRate: this.metrics.totalRequests > 0 ?(this.metrics.successfulRequests/this.metrics.totalRequests*100).toFixed(2)+'%' : '0%',retryRate: this.metrics.totalRequests > 0 ?(this.metrics.retriedRequests/this.metrics.totalRequests*100).toFixed(2)+'%' : '0%'};}getHistory(limit=50){return this.requestHistory.slice(0,limit);}clearHistory(){this.requestHistory=[];this.core.log('Request history cleared');}cancelAllRequests(){this.requestQueue.forEach(request=>{if(request.reject){request.reject(new Error('Request cancelled'));}});this.requestQueue=[];this.activeRequests.clear();this.core.log('All requests cancelled');}configure(config){if(config.maxRetries !==undefined){this.maxRetries=Math.max(0,Math.min(10,config.maxRetries));}if(config.timeout !==undefined){this.timeout=Math.max(1000,Math.min(120000,config.timeout));}if(config.maxConcurrentRequests !==undefined){this.maxConcurrentRequests=Math.max(1,Math.min(20,config.maxConcurrentRequests));}if(config.baseDelay !==undefined){this.baseDelay=Math.max(100,Math.min(10000,config.baseDelay));}this.core.log('AjaxManager configuration updated',{maxRetries: this.maxRetries,timeout: this.timeout,maxConcurrentRequests: this.maxConcurrentRequests,baseDelay: this.baseDelay});}destroy(){this.cancelAllRequests();this.notificationCallbacks.clear();this.clearHistory();this.core.log('AjaxManager destroyed');}}if(typeof module !=='undefined' && module.exports){module.exports=AjaxManager;}if(typeof define==='function' && define.amd){define([],function(){return AjaxManager;});}if(window.LAS && typeof window.LAS.registerModule==='function'){window.LAS.registerModule('ajax-manager',AjaxManager);}window.LASAjaxManager=AjaxManager;})(window,document);