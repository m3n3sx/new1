(function(window,document){'use strict';class LASCore{constructor(){this.modules=new Map();this.eventListeners=new Map();this.config=window.lasConfig ||{};this.isInitialized=false;this.loadingPromises=new Map();this.errorHandler=null;this.setupErrorHandling();this.isModernBrowser=this.checkModernBrowserSupport();this.log('LASCore initialized',{config: this.config});}checkModernBrowserSupport(){return !!(window.Promise && window.Map && window.Set && Array.prototype.includes && Object.assign);}setupErrorHandling(){window.addEventListener('error',(event)=>{this.handleError('Global Error',event.error || event.message,{filename: event.filename,lineno: event.lineno,colno: event.colno});});window.addEventListener('unhandledrejection',(event)=>{this.handleError('Unhandled Promise Rejection',event.reason,{promise: event.promise});});}async loadModule(name,path=null){try{if(this.modules.has(name)){return this.modules.get(name);}if(this.loadingPromises.has(name)){return await this.loadingPromises.get(name);}const loadingPromise=this._loadModuleInternal(name,path);this.loadingPromises.set(name,loadingPromise);const module=await loadingPromise;this.loadingPromises.delete(name);return module;}catch(error){this.loadingPromises.delete(name);this.handleError(`Failed to load module: ${name}`,error);throw error;}}async _loadModuleInternal(name,path){const modulePath=path || `${this.config.assetsUrl || '/wp-content/plugins/live-admin-styler/assets/js'}/modules/${name}.js`;if(this.isModernBrowser && window.import){try{const moduleExports=await import(modulePath);const ModuleClass=moduleExports.default || moduleExports[name];if(typeof ModuleClass==='function'){const instance=new ModuleClass(this);this.modules.set(name,instance);this.log(`Module loaded: ${name}`,{instance});return instance;}else{throw new Error(`Module ${name}does not export a constructor`);}}catch(importError){return this._loadModuleViaScript(name,modulePath);}}else{return this._loadModuleViaScript(name,modulePath);}}_loadModuleViaScript(name,modulePath){return new Promise((resolve,reject)=>{const script=document.createElement('script');script.src=modulePath;script.async=true;script.onload=()=>{try{const moduleConstructor=window.LASModules && window.LASModules[name];if(typeof moduleConstructor==='function'){const instance=new moduleConstructor(this);this.modules.set(name,instance);this.log(`Module loaded via script: ${name}`,{instance});resolve(instance);}else{reject(new Error(`Module ${name}not found in global registry`));}}catch(error){reject(error);}finally{document.head.removeChild(script);}};script.onerror=()=>{document.head.removeChild(script);reject(new Error(`Failed to load script: ${modulePath}`));};document.head.appendChild(script);});}registerModule(name,constructor){if(!window.LASModules){window.LASModules={};}window.LASModules[name]=constructor;}getModule(name){return this.modules.get(name)|| null;}hasModule(name){return this.modules.has(name);}on(event,callback,context=null){if(!this.eventListeners.has(event)){this.eventListeners.set(event,[]);}this.eventListeners.get(event).push({callback,context});}off(event,callback){if(!this.eventListeners.has(event)){return;}const listeners=this.eventListeners.get(event);const index=listeners.findIndex(listener=> listener.callback===callback);if(index !==-1){listeners.splice(index,1);}}emit(event,data=null){if(!this.eventListeners.has(event)){return;}const listeners=this.eventListeners.get(event);listeners.forEach(listener=>{try{if(listener.context){listener.callback.call(listener.context,data);}else{listener.callback(data);}}catch(error){this.handleError(`Event handler error for ${event}`,error,{data});}});}async init(){if(this.isInitialized){this.log('LASCore already initialized');return;}try{this.log('Initializing LASCore...');const essentialModules=[ 'settings-manager','live-preview','ajax-manager','live-edit-engine','micro-panel','auto-save','tab-sync','theme-manager' ];const loadPromises=essentialModules.map(moduleName=> this.loadModule(moduleName).catch(error=>{this.handleError(`Failed to load essential module: ${moduleName}`,error);return null;}));await Promise.all(loadPromises);this.isInitialized=true;this.emit('core:ready');this.log('LASCore initialization complete');}catch(error){this.handleError('LASCore initialization failed',error);throw error;}}handleError(message,error,context={}){const errorData={message,error: error instanceof Error ? error.message : error,stack: error instanceof Error ? error.stack : null,context,timestamp: new Date().toISOString()};if(this.config.debug){console.error('[LAS Error]',errorData);}this.emit('core:error',errorData);if(!window.lasErrors){window.lasErrors=[];}window.lasErrors.push(errorData);}log(message,data={}){if(this.config.debug){console.log('[LAS]',message,data);}}getSystemInfo(){return{version: this.config.version || '2.0.0',isInitialized: this.isInitialized,isModernBrowser: this.isModernBrowser,loadedModules: Array.from(this.modules.keys()),eventListeners: Array.from(this.eventListeners.keys()),config: this.config,errors: window.lasErrors || []};}destroy(){this.modules.forEach(module=>{if(typeof module.destroy==='function'){try{module.destroy();}catch(error){this.handleError('Module cleanup error',error);}}});this.modules.clear();this.eventListeners.clear();this.loadingPromises.clear();this.isInitialized=false;this.log('LASCore destroyed');}}window.LAS=new LASCore();if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>{window.LAS.init().catch(error=>{console.error('LAS initialization failed:',error);});});}else{setTimeout(()=>{window.LAS.init().catch(error=>{console.error('LAS initialization failed:',error);});},0);}})(window,document);