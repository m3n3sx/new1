<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AJAX Handlers Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #007cba;
        }
        .metric-label {
            font-weight: bold;
            font-size: 0.9em;
            color: #666;
        }
        .metric-value {
            font-size: 1.2em;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Enhanced AJAX Handlers Integration Test</h1>
    <p>This page tests the enhanced AJAX handler infrastructure with standardized responses and performance monitoring.</p>

    <div class="test-section">
        <h2>1. Settings Operations</h2>
        <button class="test-button" onclick="testLoadSettings()">Load Settings</button>
        <button class="test-button" onclick="testSaveSettings()">Save Settings</button>
        <button class="test-button" onclick="testResetSettings()">Reset Settings</button>
        <div id="settings-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. Security & Validation</h2>
        <button class="test-button" onclick="testSecurityValidation()">Test Security</button>
        <button class="test-button" onclick="testNonceRefresh()">Refresh Nonce</button>
        <button class="test-button" onclick="testInvalidRequest()">Invalid Request</button>
        <div id="security-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. Performance Monitoring</h2>
        <button class="test-button" onclick="testPerformanceMetrics()">Get Metrics</button>
        <button class="test-button" onclick="testHealthCheck()">Health Check</button>
        <button class="test-button" onclick="testBatchOperations()">Batch Operations</button>
        <div id="performance-result" class="result"></div>
        <div id="performance-metrics" class="metrics"></div>
    </div>

    <div class="test-section">
        <h2>4. Error Handling</h2>
        <button class="test-button" onclick="testErrorLogging()">Log Error</button>
        <button class="test-button" onclick="testPreviewCSS()">Generate CSS</button>
        <button class="test-button" onclick="testMalformedRequest()">Malformed Request</button>
        <div id="error-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>5. Response Format Validation</h2>
        <button class="test-button" onclick="validateResponseFormats()">Validate All Formats</button>
        <div id="validation-result" class="result"></div>
    </div>

    <script>
        // Mock WordPress AJAX URL and nonce for testing
        const ajaxUrl = '/wp-admin/admin-ajax.php';
        let currentNonce = 'test_nonce_' + Date.now();

        // Utility function to make AJAX requests
        async function makeAjaxRequest(action, data = {}) {
            const formData = new FormData();
            formData.append('action', action);
            formData.append('nonce', currentNonce);
            
            for (const [key, value] of Object.entries(data)) {
                formData.append(key, typeof value === 'object' ? JSON.stringify(value) : value);
            }

            try {
                const response = await fetch(ajaxUrl, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                return { success: true, data: result, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Display result in specified element
        function displayResult(elementId, result, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = JSON.stringify(result, null, 2);
        }

        // Display performance metrics
        function displayMetrics(metrics) {
            const container = document.getElementById('performance-metrics');
            container.innerHTML = '';
            
            if (metrics && metrics.current) {
                const current = metrics.current;
                
                const metricsToShow = [
                    { label: 'Memory Usage', value: formatBytes(current.current_memory_usage) },
                    { label: 'Peak Memory', value: formatBytes(current.peak_memory_usage) },
                    { label: 'Request Count', value: current.request_count },
                    { label: 'Avg Execution Time', value: current.average_execution_time + 'ms' }
                ];
                
                metricsToShow.forEach(metric => {
                    const card = document.createElement('div');
                    card.className = 'metric-card';
                    card.innerHTML = `
                        <div class="metric-label">${metric.label}</div>
                        <div class="metric-value">${metric.value}</div>
                    `;
                    container.appendChild(card);
                });
            }
        }

        // Format bytes to human readable
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Test functions
        async function testLoadSettings() {
            const button = event.target;
            button.disabled = true;
            
            const result = await makeAjaxRequest('las_load_settings');
            displayResult('settings-result', result, result.success ? 'success' : 'error');
            
            button.disabled = false;
        }

        async function testSaveSettings() {
            const button = event.target;
            button.disabled = true;
            
            const testSettings = {
                menu_background_color: '#2c3338',
                menu_text_color: '#f0f0f1',
                admin_bar_bg_color: '#1d2327'
            };
            
            const result = await makeAjaxRequest('las_save_settings', { settings: testSettings });
            displayResult('settings-result', result, result.success ? 'success' : 'error');
            
            button.disabled = false;
        }

        async function testResetSettings() {
            const button = event.target;
            button.disabled = true;
            
            const result = await makeAjaxRequest('las_reset_settings');
            displayResult('settings-result', result, result.success ? 'success' : 'error');
            
            button.disabled = false;
        }

        async function testSecurityValidation() {
            const button = event.target;
            button.disabled = true;
            
            // Test with current nonce
            const result = await makeAjaxRequest('las_load_settings');
            displayResult('security-result', result, result.success ? 'success' : 'error');
            
            button.disabled = false;
        }

        async function testNonceRefresh() {
            const button = event.target;
            button.disabled = true;
            
            const result = await makeAjaxRequest('las_refresh_nonce');
            
            if (result.success && result.data && result.data.data && result.data.data.nonce) {
                currentNonce = result.data.data.nonce;
                displayResult('security-result', { message: 'Nonce refreshed successfully', new_nonce: currentNonce }, 'success');
            } else {
                displayResult('security-result', result, 'error');
            }
            
            button.disabled = false;
        }

        async function testInvalidRequest() {
            const button = event.target;
            button.disabled = true;
            
            // Test with invalid nonce
            const oldNonce = currentNonce;
            currentNonce = 'invalid_nonce';
            
            const result = await makeAjaxRequest('las_save_settings', { settings: { test: 'value' } });
            displayResult('security-result', result, 'error');
            
            // Restore valid nonce
            currentNonce = oldNonce;
            button.disabled = false;
        }

        async function testPerformanceMetrics() {
            const button = event.target;
            button.disabled = true;
            
            const result = await makeAjaxRequest('las_get_performance_metrics');
            displayResult('performance-result', result, result.success ? 'success' : 'error');
            
            if (result.success && result.data && result.data.data) {
                displayMetrics(result.data.data);
            }
            
            button.disabled = false;
        }

        async function testHealthCheck() {
            const button = event.target;
            button.disabled = true;
            
            const result = await makeAjaxRequest('las_health_check');
            displayResult('performance-result', result, result.success ? 'success' : 'error');
            
            button.disabled = false;
        }

        async function testBatchOperations() {
            const button = event.target;
            button.disabled = true;
            
            const operations = [
                { type: 'save_settings', data: { test_setting_1: 'value1' } },
                { type: 'save_settings', data: { test_setting_2: 'value2' } }
            ];
            
            const result = await makeAjaxRequest('las_batch_save_settings', { operations });
            displayResult('performance-result', result, result.success ? 'success' : 'error');
            
            button.disabled = false;
        }

        async function testErrorLogging() {
            const button = event.target;
            button.disabled = true;
            
            const errorData = {
                error: 'Test JavaScript error from integration test',
                stack: 'Error\n    at testErrorLogging (integration-test.html:123:45)',
                url: window.location.href,
                userAgent: navigator.userAgent,
                lineNumber: 123,
                columnNumber: 45
            };
            
            const result = await makeAjaxRequest('las_log_error', errorData);
            displayResult('error-result', result, result.success ? 'success' : 'error');
            
            button.disabled = false;
        }

        async function testPreviewCSS() {
            const button = event.target;
            button.disabled = true;
            
            const previewSettings = {
                menu_background_color: '#ff0000',
                menu_text_color: '#ffffff'
            };
            
            const result = await makeAjaxRequest('las_get_preview_css', { preview_settings: previewSettings });
            displayResult('error-result', result, result.success ? 'success' : 'error');
            
            button.disabled = false;
        }

        async function testMalformedRequest() {
            const button = event.target;
            button.disabled = true;
            
            // Send malformed JSON
            const result = await makeAjaxRequest('las_save_settings', { settings: 'invalid_json{' });
            displayResult('error-result', result, 'error');
            
            button.disabled = false;
        }

        async function validateResponseFormats() {
            const button = event.target;
            button.disabled = true;
            
            const tests = [
                { name: 'Load Settings', action: 'las_load_settings' },
                { name: 'Performance Metrics', action: 'las_get_performance_metrics' },
                { name: 'Health Check', action: 'las_health_check' },
                { name: 'Nonce Refresh', action: 'las_refresh_nonce' }
            ];
            
            const results = [];
            
            for (const test of tests) {
                const result = await makeAjaxRequest(test.action);
                
                const validation = {
                    test: test.name,
                    hasStandardFields: false,
                    hasMetadata: false,
                    executionTime: null,
                    memoryUsage: null
                };
                
                if (result.success && result.data) {
                    const response = result.data;
                    
                    // Check standard fields
                    validation.hasStandardFields = 
                        response.hasOwnProperty('success') &&
                        response.hasOwnProperty('message') &&
                        response.hasOwnProperty('meta');
                    
                    // Check metadata
                    if (response.meta) {
                        validation.hasMetadata = 
                            response.meta.hasOwnProperty('timestamp') &&
                            response.meta.hasOwnProperty('execution_time_ms') &&
                            response.meta.hasOwnProperty('memory_usage') &&
                            response.meta.hasOwnProperty('request_id');
                        
                        validation.executionTime = response.meta.execution_time_ms;
                        validation.memoryUsage = response.meta.memory_usage_formatted;
                    }
                }
                
                results.push(validation);
            }
            
            displayResult('validation-result', results, 'info');
            button.disabled = false;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced AJAX Handlers Integration Test loaded');
            console.log('Current nonce:', currentNonce);
        });
    </script>
</body>
</html>