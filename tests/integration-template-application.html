<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Application Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f1f1f1;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #0073aa;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .template-card {
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .template-card:hover {
            border-color: #0073aa;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,115,170,0.1);
        }
        
        .template-card.active {
            border-color: #0073aa;
            background: #f8f9fa;
        }
        
        .template-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #23282d;
        }
        
        .template-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .template-category {
            display: inline-block;
            background: #0073aa;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 15px;
        }
        
        .template-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #0073aa;
            color: white;
        }
        
        .btn-primary:hover {
            background: #005a87;
        }
        
        .btn-secondary {
            background: #f1f1f1;
            color: #23282d;
        }
        
        .btn-secondary:hover {
            background: #e1e1e1;
        }
        
        .status-panel {
            background: #f8f9fa;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .status-title {
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .status-message {
            color: #666;
            margin-bottom: 10px;
        }
        
        .preview-area {
            background: #23282d;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            min-height: 200px;
            transition: all 0.3s ease;
        }
        
        .preview-adminbar {
            background: var(--adminbar-bg, #23282d);
            color: var(--adminbar-color, #ffffff);
            padding: 8px 16px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .preview-menu {
            background: var(--menu-bg, #23282d);
            color: var(--menu-color, #ffffff);
            padding: 16px;
            border-radius: var(--menu-radius, 0);
            margin-bottom: 10px;
        }
        
        .preview-content {
            background: var(--content-bg, #f1f1f1);
            color: var(--content-color, #23282d);
            padding: 20px;
            border-radius: 4px;
            font-family: var(--content-font, system-ui);
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .success {
            color: #46b450;
        }
        
        .error {
            color: #dc3232;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Template Application Integration Test</h1>
            <p>Test one-click template application functionality</p>
        </div>
        
        <div class="content">
            <div class="template-actions-bar" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-primary" onclick="showCreateTemplateDialog()">Create Custom Template</button>
                <button class="btn btn-secondary" onclick="triggerImportDialog()">Import Template</button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">
                <span style="margin-left: auto; color: #666;">Total Templates: <span id="templateCount">0</span></span>
            </div>
            
            <div class="template-grid" id="templateGrid">
                <!-- Templates will be loaded here -->
            </div>
            
            <div class="status-panel">
                <div class="status-title">Status</div>
                <div class="status-message" id="statusMessage">Ready to test template application</div>
                <div id="appliedSettings"></div>
            </div>
            
            <div class="preview-area" id="previewArea">
                <div class="preview-adminbar">Admin Bar Preview</div>
                <div class="preview-menu">Menu Preview</div>
                <div class="preview-content">Content Area Preview</div>
            </div>
        </div>
    </div>

    <script>
        // Mock template data for testing
        const mockTemplates = {
            minimal: {
                name: 'Minimal',
                description: 'Clean, white space focused design with minimal visual elements',
                category: 'clean',
                settings: {
                    general: { theme_mode: 'light' },
                    menu: { 
                        background_color: '#ffffff',
                        text_color: '#2c3338',
                        border_radius: '0px'
                    },
                    adminbar: {
                        background_color: '#ffffff',
                        text_color: '#2c3338'
                    },
                    content: {
                        background_color: '#ffffff',
                        font_family: 'system-ui'
                    }
                }
            },
            glassmorphism: {
                name: 'Glassmorphism',
                description: 'Modern frosted glass effects with backdrop blur and transparency',
                category: 'modern',
                settings: {
                    general: { theme_mode: 'auto' },
                    menu: {
                        background_color: 'rgba(255, 255, 255, 0.1)',
                        text_color: '#ffffff',
                        border_radius: '12px'
                    },
                    adminbar: {
                        background_color: 'rgba(35, 40, 45, 0.8)',
                        text_color: '#ffffff'
                    },
                    content: {
                        background_color: 'rgba(241, 241, 241, 0.9)',
                        font_family: 'Inter'
                    }
                }
            },
            ios: {
                name: 'iOS',
                description: 'Apple iOS inspired design with rounded corners and smooth animations',
                category: 'mobile',
                settings: {
                    general: { theme_mode: 'light' },
                    menu: {
                        background_color: '#f2f2f7',
                        text_color: '#1c1c1e',
                        border_radius: '16px'
                    },
                    adminbar: {
                        background_color: '#f2f2f7',
                        text_color: '#1c1c1e'
                    },
                    content: {
                        background_color: '#ffffff',
                        font_family: '-apple-system, BlinkMacSystemFont'
                    }
                }
            }
        };
        
        let currentTemplate = null;
        
        // Initialize the test
        function init() {
            renderTemplates();
            updateTemplateCount();
            updateStatus('Templates loaded. Click "Apply" to test template application.');
        }
        
        // Update template count
        function updateTemplateCount() {
            const count = Object.keys(mockTemplates).length;
            document.getElementById('templateCount').textContent = count;
        }
        
        // Render template cards
        function renderTemplates() {
            const grid = document.getElementById('templateGrid');
            grid.innerHTML = '';
            
            Object.entries(mockTemplates).forEach(([id, template]) => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.innerHTML = `
                    <div class="template-category">${template.category}</div>
                    <div class="template-name">${template.name}</div>
                    <div class="template-description">${template.description}</div>
                    <div class="template-actions">
                        <button class="btn btn-primary" onclick="applyTemplate('${id}')">Apply</button>
                        <button class="btn btn-secondary" onclick="previewTemplate('${id}')">Preview</button>
                        ${template.type === 'custom' ? `
                            <button class="btn btn-secondary" onclick="exportTemplate('${id}')">Export</button>
                            <button class="btn" style="background: #dc3232; color: white;" onclick="deleteTemplate('${id}')">Delete</button>
                        ` : `
                            <button class="btn btn-secondary" onclick="exportTemplate('${id}')">Export</button>
                        `}
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // Apply template (one-click application)
        async function applyTemplate(templateId) {
            const template = mockTemplates[templateId];
            if (!template) {
                updateStatus('Template not found', 'error');
                return;
            }
            
            updateStatus('Applying template...', 'loading');
            
            try {
                // Simulate AJAX request delay
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Apply template settings
                const appliedSettings = {};
                let settingsCount = 0;
                
                Object.entries(template.settings).forEach(([section, sectionSettings]) => {
                    Object.entries(sectionSettings).forEach(([key, value]) => {
                        const settingKey = `${section}_${key}`;
                        appliedSettings[settingKey] = value;
                        settingsCount++;
                    });
                });
                
                // Update preview
                updatePreview(template.settings);
                
                // Mark as active
                markTemplateAsActive(templateId);
                
                // Update status
                updateStatus(`Template "${template.name}" applied successfully! ${settingsCount} settings updated.`, 'success');
                
                // Show applied settings
                showAppliedSettings(appliedSettings);
                
                currentTemplate = templateId;
                
            } catch (error) {
                updateStatus('Failed to apply template: ' + error.message, 'error');
            }
        }
        
        // Preview template
        function previewTemplate(templateId) {
            const template = mockTemplates[templateId];
            if (!template) {
                updateStatus('Template not found', 'error');
                return;
            }
            
            updatePreview(template.settings);
            updateStatus(`Previewing template "${template.name}". Click "Apply" to make changes permanent.`);
        }
        
        // Update preview area
        function updatePreview(settings) {
            const previewArea = document.getElementById('previewArea');
            const root = document.documentElement;
            
            // Apply CSS variables for preview
            if (settings.adminbar) {
                root.style.setProperty('--adminbar-bg', settings.adminbar.background_color || '#23282d');
                root.style.setProperty('--adminbar-color', settings.adminbar.text_color || '#ffffff');
            }
            
            if (settings.menu) {
                root.style.setProperty('--menu-bg', settings.menu.background_color || '#23282d');
                root.style.setProperty('--menu-color', settings.menu.text_color || '#ffffff');
                root.style.setProperty('--menu-radius', settings.menu.border_radius || '0');
            }
            
            if (settings.content) {
                root.style.setProperty('--content-bg', settings.content.background_color || '#f1f1f1');
                root.style.setProperty('--content-color', settings.content.text_color || '#23282d');
                root.style.setProperty('--content-font', settings.content.font_family || 'system-ui');
            }
            
            // Add animation
            previewArea.style.transform = 'scale(0.98)';
            setTimeout(() => {
                previewArea.style.transform = 'scale(1)';
            }, 100);
        }
        
        // Mark template as active
        function markTemplateAsActive(templateId) {
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('active');
            });
            
            const cards = document.querySelectorAll('.template-card');
            const templateIds = Object.keys(mockTemplates);
            const index = templateIds.indexOf(templateId);
            
            if (index >= 0 && cards[index]) {
                cards[index].classList.add('active');
            }
        }
        
        // Show applied settings
        function showAppliedSettings(settings) {
            const container = document.getElementById('appliedSettings');
            
            const settingsList = Object.entries(settings)
                .map(([key, value]) => `<li><strong>${key}:</strong> ${value}</li>`)
                .join('');
            
            container.innerHTML = `
                <div style="margin-top: 15px;">
                    <strong>Applied Settings:</strong>
                    <ul style="margin: 10px 0; padding-left: 20px; max-height: 200px; overflow-y: auto;">
                        ${settingsList}
                    </ul>
                </div>
            `;
        }
        
        // Update status message
        function updateStatus(message, type = '') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message ' + type;
            
            if (type === 'loading') {
                document.body.classList.add('loading');
            } else {
                document.body.classList.remove('loading');
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
        
        // Test results tracking
        const testResults = {
            templatesLoaded: false,
            templateApplied: false,
            previewWorking: false,
            settingsApplied: false,
            customTemplateCreated: false,
            templateExported: false,
            templateImported: false,
            templateDeleted: false
        };
        
        // Mark tests as passed
        function markTestPassed(testName) {
            testResults[testName] = true;
            console.log(`✓ Test passed: ${testName}`);
            
            // Check if all tests passed
            const allPassed = Object.values(testResults).every(result => result === true);
            if (allPassed) {
                console.log('🎉 All template application tests passed!');
                updateStatus('All tests passed! Template application is working correctly.', 'success');
            }
        }
        
        // Mark initial test as passed
        setTimeout(() => {
            markTestPassed('templatesLoaded');
        }, 100);
        
        // Override apply function to track test results
        const originalApplyTemplate = applyTemplate;
        applyTemplate = async function(templateId) {
            await originalApplyTemplate(templateId);
            markTestPassed('templateApplied');
            markTestPassed('settingsApplied');
        };
        
        // Override preview function to track test results
        const originalPreviewTemplate = previewTemplate;
        previewTemplate = function(templateId) {
            originalPreviewTemplate(templateId);
            markTestPassed('previewWorking');
        };
        
        // Custom template creation
        function showCreateTemplateDialog() {
            const name = prompt('Enter template name:');
            if (!name) return;
            
            const description = prompt('Enter template description (optional):') || 'Custom template';
            const category = prompt('Enter template category (optional):') || 'custom';
            
            createCustomTemplate(name, description, category);
        }
        
        async function createCustomTemplate(name, description, category) {
            updateStatus('Creating custom template...', 'loading');
            
            try {
                // Simulate getting current settings
                const currentSettings = getCurrentSettings();
                
                // Generate unique ID
                const templateId = 'custom_' + Date.now();
                
                // Create template object
                const newTemplate = {
                    name: name,
                    description: description,
                    category: category,
                    type: 'custom',
                    settings: currentSettings,
                    created_at: new Date().toISOString()
                };
                
                // Add to mock templates
                mockTemplates[templateId] = newTemplate;
                
                // Re-render templates
                renderTemplates();
                updateTemplateCount();
                
                updateStatus(`Custom template "${name}" created successfully!`, 'success');
                
                // Mark as active
                markTemplateAsActive(templateId);
                
            } catch (error) {
                updateStatus('Failed to create custom template: ' + error.message, 'error');
            }
        }
        
        // Get current settings (mock implementation)
        function getCurrentSettings() {
            if (currentTemplate && mockTemplates[currentTemplate]) {
                return { ...mockTemplates[currentTemplate].settings };
            }
            
            // Default settings if no template is active
            return {
                general: { theme_mode: 'light' },
                menu: {
                    background_color: '#23282d',
                    text_color: '#ffffff',
                    border_radius: '0px'
                },
                adminbar: {
                    background_color: '#23282d',
                    text_color: '#ffffff'
                },
                content: {
                    background_color: '#f1f1f1',
                    font_family: 'system-ui'
                }
            };
        }
        
        // Export template
        function exportTemplate(templateId) {
            const template = mockTemplates[templateId];
            if (!template) {
                updateStatus('Template not found', 'error');
                return;
            }
            
            try {
                // Create export data
                const exportData = {
                    name: template.name,
                    description: template.description,
                    category: template.category,
                    settings: template.settings,
                    version: '2.0.0',
                    exported_at: new Date().toISOString(),
                    exported_by: 'test_user'
                };
                
                // Create and download file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${template.name.toLowerCase().replace(/\s+/g, '-')}-template.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                updateStatus(`Template "${template.name}" exported successfully!`, 'success');
                
            } catch (error) {
                updateStatus('Failed to export template: ' + error.message, 'error');
            }
        }
        
        // Trigger import dialog
        function triggerImportDialog() {
            document.getElementById('importFileInput').click();
        }
        
        // Handle file import
        async function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            updateStatus('Importing template...', 'loading');
            
            try {
                // Validate file type
                if (!file.type.includes('json') && !file.name.endsWith('.json')) {
                    throw new Error('Please select a valid JSON file');
                }
                
                // Validate file size (max 1MB)
                if (file.size > 1024 * 1024) {
                    throw new Error('File size too large. Maximum size is 1MB');
                }
                
                // Read file content
                const fileContent = await readFileAsText(file);
                
                // Parse JSON
                let importData;
                try {
                    importData = JSON.parse(fileContent);
                } catch (parseError) {
                    throw new Error('Invalid JSON file format');
                }
                
                // Validate import data
                const validation = validateImportData(importData);
                if (!validation.valid) {
                    throw new Error('Invalid template file: ' + validation.errors.join(', '));
                }
                
                // Import template
                await importTemplate(importData, file.name);
                
            } catch (error) {
                updateStatus('Failed to import template: ' + error.message, 'error');
            }
            
            // Clear file input
            event.target.value = '';
        }
        
        // Read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }
        
        // Validate import data
        function validateImportData(importData) {
            const errors = [];
            
            // Check required fields
            if (!importData.name || typeof importData.name !== 'string') {
                errors.push('Missing or invalid template name');
            }
            
            if (!importData.settings || typeof importData.settings !== 'object') {
                errors.push('Missing or invalid template settings');
            }
            
            if (!importData.version) {
                errors.push('Missing version information');
            } else {
                const majorVersion = importData.version.split('.')[0];
                if (majorVersion !== '2') {
                    errors.push('Template version not compatible with current plugin version');
                }
            }
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }
        
        // Import template
        async function importTemplate(importData, filename) {
            // Generate unique ID
            const templateId = 'imported_' + Date.now();
            
            // Create template object
            const importedTemplate = {
                name: importData.name + ' (Imported)',
                description: importData.description || 'Imported template',
                category: importData.category || 'imported',
                type: 'custom',
                settings: importData.settings,
                imported_at: new Date().toISOString(),
                original_name: importData.name
            };
            
            // Add to mock templates
            mockTemplates[templateId] = importedTemplate;
            
            // Re-render templates
            renderTemplates();
            updateTemplateCount();
            
            updateStatus(`Template "${importData.name}" imported successfully from ${filename}!`, 'success');
            
            // Mark as active
            markTemplateAsActive(templateId);
        }
        
        // Delete custom template
        function deleteTemplate(templateId) {
            const template = mockTemplates[templateId];
            if (!template) {
                updateStatus('Template not found', 'error');
                return;
            }
            
            if (template.type !== 'custom') {
                updateStatus('Cannot delete built-in template', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete the template "${template.name}"?`)) {
                return;
            }
            
            try {
                // Remove from mock templates
                delete mockTemplates[templateId];
                
                // Re-render templates
                renderTemplates();
                updateTemplateCount();
                
                // Clear current template if it was deleted
                if (currentTemplate === templateId) {
                    currentTemplate = null;
                }
                
                updateStatus(`Template "${template.name}" deleted successfully!`, 'success');
                
            } catch (error) {
                updateStatus('Failed to delete template: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>